---
import { getRelativeLocaleUrl } from 'astro:i18n';
import { Image } from 'astro:assets';
import phoraLogo from '../assets/phora-logo.svg';
import MobileMenu from './MobileMenu.astro'; // Import MobileMenu

const currentLang = Astro.currentLocale || 'en';

const nav = [
  { label: currentLang === 'en' ? 'Home' : 'Anasayfa', href: '' }, // empty string for home relative
  { label: currentLang === 'en' ? 'About Us' : 'Hakkımızda', href: 'about' },
  { label: currentLang === 'en' ? 'Solutions' : 'Çözümler', href: 'solutions' }, 
  { label: currentLang === 'en' ? 'Contact' : 'İletişim', href: 'contact' },
];

const currentPath = Astro.url.pathname;
let enUrl = currentPath;
let trUrl = currentPath;

if (currentLang === 'tr') {
    // Current is TR (/tr/...) -> EN is just removing /tr
    enUrl = currentPath.replace(/^\/tr/, '') || '/';
} else {
    // Current is EN (/) -> TR is adding /tr
    // Handle root / case
    trUrl = '/tr' + (currentPath === '/' ? '' : currentPath);
}

// Ensure no double slashes if path was just /
if (enUrl === '') enUrl = '/';

// Construct final URLs for language switcher to handle `?lang=en` for explicit English selection
let finalEnLink = enUrl;
if (!finalEnLink.includes('?')) {
    finalEnLink += '?lang=en';
} else if (!finalEnLink.includes('lang=en')) {
    finalEnLink += '&lang=en';
}

// Ensure the Turkish link does not contain `?lang=en`
let finalTrLink = trUrl.replace(/(\?|&)?lang=en(&|$)/g, (match, p1, p2) => {
    // If it was the only query param or first param, remove '?'
    if (p1 === '?' && p2 === '') return '';
    // If it was subsequent param, remove '&'
    if (p1 === '&') return '&';
    return ''; // Should not happen with current regex, but safety
}).replace(/\?$/, ''); // Remove trailing '?' if all params are gone


---
<header class="bg-white shadow-sm sticky top-0 z-50 border-b border-gray-100">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between h-20 items-center">
      <!-- Logo -->
      <div class="flex-shrink-0 flex items-center">
        <a href={getRelativeLocaleUrl(currentLang, '')} class="group">
          <Image src={phoraLogo} alt="Phora Total Control" class="h-12 w-auto" loading="eager" />
        </a>
      </div>

      <!-- Desktop Menu -->
      <nav class="hidden md:flex space-x-8">
        {nav.map(item => (
          <a
            href={getRelativeLocaleUrl(currentLang, item.href)}
            class="text-gray-700 hover:text-primary font-medium transition-colors text-sm uppercase tracking-wide"
          >
            {item.label}
          </a>
        ))}
      </nav>

      <!-- Lang Switcher -->
      <div class="flex items-center space-x-3 text-sm font-medium border-l border-gray-200 pl-4 ml-4">
        <a
            href={finalEnLink}
            class={`transition-colors ${currentLang === 'en' ? 'text-primary font-bold' : 'text-gray-400 hover:text-gray-600'}`}
        >
            EN
        </a>
        <span class="text-gray-300">|</span>
        <a
            href={finalTrLink}
            class={`transition-colors ${currentLang === 'tr' ? 'text-primary font-bold' : 'text-gray-400 hover:text-gray-600'}`}
        >
            TR
        </a>
      </div>
      
       <!-- Mobile Menu Button -->
       <div class="md:hidden ml-4">
         <button id="open-mobile-menu-btn" class="text-gray-500 hover:text-primary focus:outline-none">
           <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
           </svg>
         </button>
       </div>
    </div>
  </div>
</header>

<MobileMenu navItems={nav} currentLang={currentLang} />

<script>
  function setupMobileMenu() {
    const mobileMenuPanel = document.getElementById('mobile-menu-panel');
    const openButton = document.getElementById('open-mobile-menu-btn');
    const closeButton = document.getElementById('close-mobile-menu-btn');

    if (!mobileMenuPanel || !openButton || !closeButton) return;

    // Remove existing listeners to avoid duplicates if re-ran
    const newOpenButton = openButton.cloneNode(true);
    openButton.parentNode.replaceChild(newOpenButton, openButton);
    
    const newCloseButton = closeButton.cloneNode(true);
    closeButton.parentNode.replaceChild(newCloseButton, closeButton);

    function toggleMobileMenu() {
        mobileMenuPanel.classList.toggle('translate-x-full');
        mobileMenuPanel.classList.toggle('translate-x-0');
    }

    newOpenButton.addEventListener('click', toggleMobileMenu);
    newCloseButton.addEventListener('click', toggleMobileMenu);

    mobileMenuPanel.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', () => {
        if (mobileMenuPanel.classList.contains('translate-x-0')) {
          toggleMobileMenu();
        }
      });
    });
  }

  // Run on initial load
  document.addEventListener('DOMContentLoaded', setupMobileMenu);
  // Run on view transitions (if added later)
  document.addEventListener('astro:page-load', setupMobileMenu);
</script>

